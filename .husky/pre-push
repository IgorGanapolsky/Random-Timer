#!/usr/bin/env sh

# POSIX-compatible pre-push hook (no bash arrays / [[ ]])
# Validates branch naming and performs a lightweight quality gate.

# Allow CI / automated pushes (like GitHub Actions) to skip this hook
if [ "$CI" = "true" ] || [ "$SKIP_HUSKY" = "1" ]; then
  echo "[pre-push] Skipping (CI / SKIP_HUSKY set)"
  exit 0
fi

BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo HEAD)

# Branch naming validation - enforce Subway Channels Mobile Gitflow strategy
# Official Gitflow prefixes: feature/, bugfix/, hotfix/, release/, build/
# Additional allowed: task/, pbi/, docs/, spike/, chore/, refactor/
# Protected branches are exempt: main, master, develop, staging, production
PROTECTED_BRANCHES="^(main|master|develop|staging|production)$"
VALID_PREFIXES="^(feature|bugfix|hotfix|release|build|task|pbi|docs|spike|chore|refactor)/"

if echo "$BRANCH_NAME" | grep -Eq "$PROTECTED_BRANCHES"; then
  echo "âœ… Branch validation skipped (protected branch: $BRANCH_NAME)"
elif echo "$BRANCH_NAME" | grep -Eq "$VALID_PREFIXES"; then
  echo "âœ… Branch name valid: $BRANCH_NAME"
else
  echo "âŒ Invalid branch name: $BRANCH_NAME" >&2
  echo "" >&2
  echo "Branch names must follow Subway Channels Mobile Gitflow strategy:" >&2
  echo "" >&2
  echo "Official Gitflow branches:" >&2
  echo "  â€¢ feature/    - New features (from develop)" >&2
  echo "  â€¢ bugfix/     - Bug fixes (from develop)" >&2
  echo "  â€¢ hotfix/     - Production hotfixes (from main)" >&2
  echo "  â€¢ release/    - Release candidates (format: release/M.m.R)" >&2
  echo "  â€¢ build/      - Build/UAT branches (build/UAT or build/M.m.R)" >&2
  echo "" >&2
  echo "Additional allowed prefixes:" >&2
  echo "  â€¢ task/       - General tasks" >&2
  echo "  â€¢ pbi/        - Product Backlog Items (Azure DevOps)" >&2
  echo "  â€¢ docs/       - Documentation-only changes" >&2
  echo "  â€¢ spike/      - Research/exploration" >&2
  echo "  â€¢ chore/      - Maintenance (deps, configs, tooling)" >&2
  echo "  â€¢ refactor/   - Code restructuring (no functional changes)" >&2
  echo "" >&2
  echo "Examples:" >&2
  echo "  feature/add-payment-flow" >&2
  echo "  bugfix/fix-login-crash" >&2
  echo "  hotfix/1.2.3-critical-security-fix" >&2
  echo "  release/1.2.0" >&2
  echo "  build/UAT" >&2
  echo "  build/1.2.0" >&2
  echo "  docs/update-readme" >&2
  echo "" >&2
  echo "Current branch: $BRANCH_NAME" >&2
  echo "ðŸ’¡ Rename with: git branch -m $BRANCH_NAME <new-name>" >&2
  exit 1
fi

echo "[pre-push] Running quality checks..."

# Validate expo prebuild is in sync (unless skipped)
if [ "$SKIP_PREBUILD_CHECK" != "1" ]; then
  if [ -x "./scripts/validate-expo-prebuild.sh" ]; then
    ./scripts/validate-expo-prebuild.sh || exit 1
  else
    echo "[pre-push] âš ï¸  Expo prebuild validation script not found or not executable"
  fi
else
  echo "[pre-push] Expo prebuild validation skipped (SKIP_PREBUILD_CHECK=1)"
fi

# Optional: Run act local CI validation (requires Docker)
if [ "$RUN_ACT" = "1" ]; then
  echo "[pre-push] ðŸŽ¬ Running local CI with act..."
  if ! command -v act >/dev/null 2>&1; then
    echo "[pre-push] âš ï¸  act not installed (brew install act)"
  elif ! docker info >/dev/null 2>&1; then
    echo "[pre-push] âš ï¸  Docker not running"
  else
    act pull_request -W .github/workflows/ci.yml --quiet || {
      echo "[pre-push] âŒ Local CI failed"
      exit 1
    }
    echo "[pre-push] âœ… Local CI passed"
  fi
fi

# Determine diff range safely (handle first commit)
if git rev-parse HEAD~1 >/dev/null 2>&1; then
  DIFF_RANGE="HEAD~1..HEAD"
else
  DIFF_RANGE="HEAD"
fi

# Check for workflow changes and validate them
WORKFLOW_FILES=$(git diff --name-only "${DIFF_RANGE}" | grep -E '\.github/workflows/.*\.yml$' || true)
if [ -n "${WORKFLOW_FILES}" ]; then
  echo "[pre-push] Validating workflow changes..."
  if [ -x "./scripts/validate-workflows.sh" ]; then
    ./scripts/validate-workflows.sh || {
      echo "[pre-push] âŒ Workflow validation failed" >&2
      exit 1
    }
    echo "[pre-push] âœ… Workflow validation passed"
  else
    echo "[pre-push] âš ï¸ Workflow validation script not found"
  fi

  # Validate CodeQL configuration at correct location
  echo "[pre-push] Validating CodeQL configuration..."
  if [ -f ".github/codeql/codeql-config.yml" ]; then
    # Use workflow validator agent if available
    if [ -f "agents/workflow-validator-agent.ts" ]; then
      if ! npx tsx agents/workflow-validator-agent.ts >/dev/null 2>&1; then
        echo "[pre-push] âŒ CodeQL configuration validation failed" >&2
        echo "[pre-push] ðŸ’¡ Run 'npx tsx agents/workflow-validator-agent.ts' to see details" >&2
        echo "[pre-push] ðŸ’¡ Run 'npx tsx agents/workflow-validator-agent.ts --fix' to auto-fix" >&2
        exit 1
      fi
    else
      # Fallback to basic YAML syntax check using node
      if command -v node >/dev/null 2>&1; then
        if ! node -e "require('fs').readFileSync('.github/codeql/codeql-config.yml', 'utf8')" 2>/dev/null; then
          echo "[pre-push] âŒ CodeQL configuration file not readable" >&2
          exit 1
        fi
      else
        echo "[pre-push] âš ï¸  Skipping CodeQL validation (no validator available)"
      fi
    fi
    echo "[pre-push] âœ… CodeQL configuration validated"
  fi

  # Check for old/conflicting CodeQL config location
  if [ -f ".github/codeql-config.yml" ]; then
    echo "[pre-push] âŒ CodeQL config in wrong location - should be .github/codeql/codeql-config.yml" >&2
    echo "[pre-push] ðŸ’¡ Move to correct location or remove if duplicate" >&2
    exit 1
  fi
fi

# Check for dependency review config changes
DEP_CONFIG_FILES=$(git diff --name-only "${DIFF_RANGE}" | grep -E '\.github/dependency-review-config\.yml$' || true)
if [ -n "${DEP_CONFIG_FILES}" ]; then
  echo "[pre-push] Validating dependency review config..."
  # Use comprehensive dependency config validator
  if [ -x "./scripts/validate-dependency-config.py" ]; then
    ./scripts/validate-dependency-config.py || {
      echo "[pre-push] âŒ Dependency config validation failed" >&2
      exit 1
    }
  elif command -v python3 >/dev/null 2>&1; then
    python3 -c "import yaml; yaml.safe_load(open('.github/dependency-review-config.yml'))" || {
      echo "[pre-push] âŒ Invalid YAML in dependency-review-config.yml" >&2
      exit 1
    }
    echo "[pre-push] âœ… Basic YAML validation passed"
  else
    echo "[pre-push] âš ï¸ Python3 not available for validation"
  fi
fi

COMMITTED_FILES=$(git diff --name-only "${DIFF_RANGE}" | grep -E '\.(js|jsx|ts|tsx)$' | grep -v '^scripts/' | grep -v '^\.claude/' | grep -v '^\.husky/' | grep -v '^test/' | grep -v '\.test\.\(ts\|tsx\|js\|jsx\)$' | grep -v '/__tests__/' | tr '\n' ' ' || true)

# Filter out deleted files to avoid linting errors
EXISTING_FILES=""
for file in $COMMITTED_FILES; do
  if [ -f "$file" ]; then
    EXISTING_FILES="$EXISTING_FILES $file"
  fi
done

if [ -n "$EXISTING_FILES" ]; then
  echo "[pre-push] Linting: $EXISTING_FILES"
  if [ -x "./node_modules/.bin/eslint" ]; then
    ./node_modules/.bin/eslint ${EXISTING_FILES} || {
      echo "[pre-push] âŒ Lint failed" >&2
      exit 1
    }
  elif command -v npx >/dev/null 2>&1; then
    npx eslint ${EXISTING_FILES} || {
      echo "[pre-push] âŒ Lint failed" >&2
      exit 1
    }
  else
    echo "[pre-push] (Skipping lint - eslint not available)"
  fi
else
  echo "[pre-push] No JS/TS files to lint"
fi

# Run tests (currently placeholder returns 0) â€“ allow override
if [ "$SKIP_TESTS" = "1" ]; then
  echo "[pre-push] Tests skipped (SKIP_TESTS=1)"
elif [ -z "$COMMITTED_FILES" ]; then
  echo "[pre-push] Tests skipped (no JS/TS files changed)"
else
  # Run a quick subset of tests to avoid hanging the push
  if ! npm run test -- --watch=false >/dev/null 2>&1; then
    echo "[pre-push] âŒ Tests failed" >&2
    exit 1
  fi
fi

echo "[pre-push] âœ… Quality gate passed"
