#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üöÄ Running comprehensive pre-push security checks..."

# 1. GitGuardian Secret Scan (full repository)
echo "üõ°Ô∏è  GitGuardian Full Repository Scan..."
if command -v ggshield >/dev/null 2>&1; then
    ggshield secret scan
    if [ $? -ne 0 ]; then
        echo "‚ùå GitGuardian found secrets in repository! Push blocked."
        exit 1
    fi
    echo "‚úÖ GitGuardian full scan passed"
else
    echo "‚ö†Ô∏è  GitGuardian not installed. Run: pipx install ggshield"
fi

# 2. TypeScript checks
echo "üîé Running TypeScript checks..."
yarn tsc --noEmit || exit 1

# 3. Run test suite
echo "üß™ Running test suite..."
yarn test:coverage || exit 1

# 4. Coverage checks
if [ -f "coverage/lcov.info" ]; then
    echo "üìä Checking test coverage..."
    # Check if lcov is installed
    if command -v lcov >/dev/null 2>&1; then
        # Extract coverage percentages
        LINES=$(lcov --summary coverage/lcov.info 2>/dev/null | grep "lines" | awk '{print $2}' | cut -d'.' -f1)
        FUNCTIONS=$(lcov --summary coverage/lcov.info 2>/dev/null | grep "functions" | awk '{print $2}' | cut -d'.' -f1)
        BRANCHES=$(lcov --summary coverage/lcov.info 2>/dev/null | grep "branches" | awk '{print $2}' | cut -d'.' -f1)

        # Only check thresholds if we got valid numbers
        if [ -n "$LINES" ] && [ -n "$FUNCTIONS" ] && [ -n "$BRANCHES" ]; then
            echo "Coverage Report:"
            echo "  Lines: $LINES%"
            echo "  Functions: $FUNCTIONS%"
            echo "  Branches: $BRANCHES%"

            # Check against thresholds
            if [ "$LINES" -lt 15 ] || [ "$FUNCTIONS" -lt 5 ] || [ "$BRANCHES" -lt 15 ]; then
                echo "‚ùå Test coverage is below minimum threshold!"
                echo "üö´ Push blocked due to insufficient coverage!"
                exit 1
            fi
            echo "‚úÖ Coverage requirements met"
        else
            echo "‚ö†Ô∏è  Could not parse coverage data"
        fi
    else
        echo "‚ö†Ô∏è  lcov not installed, skipping coverage threshold check"
    fi
fi

# 5. Security audit
echo "üîí Running security audit..."
yarn audit --audit-level=high
if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è  Security vulnerabilities found in dependencies (not blocking push)"
fi
echo "‚úÖ Security audit completed"

# 6. Check for sensitive files
echo "üìÅ Checking for sensitive files..."
SENSITIVE_FILES=$(find . -name "*.key" -o -name "*.pem" -o -name "*.p12" -o -name "*.pfx" -o -name "*.crt" -o -name "*.cer" -o -name "*.der" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./ios/.xcode.env" -not -path "./.env" | wc -l)
if [ "$SENSITIVE_FILES" -gt 0 ]; then
    echo "‚ùå Found $SENSITIVE_FILES sensitive files!"
    find . -name "*.key" -o -name "*.pem" -o -name "*.p12" -o -name "*.pfx" -o -name "*.crt" -o -name "*.cer" -o -name "*.der" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./ios/.xcode.env" -not -path "./.env"
    echo "üö´ Push blocked due to sensitive files!"
    exit 1
fi
echo "‚úÖ No sensitive files found"

# 7. Final validation
echo "üîê Final security validation..."
echo "‚úÖ All pre-push security checks passed! Push allowed."
