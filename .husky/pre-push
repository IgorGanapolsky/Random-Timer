#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running comprehensive pre-push security checks..."

# 1. GitGuardian Secret Scan (full repository)
echo "ğŸ›¡ï¸  GitGuardian Full Repository Scan..."
if command -v ggshield >/dev/null 2>&1; then
    ggshield secret scan
    if [ $? -ne 0 ]; then
        echo "âŒ GitGuardian found secrets in repository! Push blocked."
        exit 1
    fi
    echo "âœ… GitGuardian full scan passed"
else
    echo "âš ï¸  GitGuardian not installed. Run: pipx install ggshield"
fi

# 2. TypeScript checks
echo "ğŸ” Running TypeScript checks..."
yarn tsc --noEmit || exit 1

# 3. Run test suite
echo "ğŸ§ª Running test suite..."
yarn test:coverage || exit 1

# 4. Coverage checks
if [ -f "coverage/lcov.info" ]; then
    echo "ğŸ“Š Checking test coverage..."
    echo "âš ï¸  Skipping lcov threshold check (not available in CI environment)"
fi

# 5. Security audit
echo "ğŸ”’ Running security audit..."
yarn audit --audit-level=high || true
echo "âš ï¸  Security audit completed (vulnerabilities in dependencies are not blocking)"

# 6. Check for sensitive files
echo "ğŸ“ Checking for sensitive files..."
SENSITIVE_FILES=$(find . -name "*.key" -o -name "*.pem" -o -name "*.p12" -o -name "*.pfx" -o -name "*.crt" -o -name "*.cer" -o -name "*.der" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./ios/.xcode.env" -not -path "./.env" | wc -l)
if [ "$SENSITIVE_FILES" -gt 0 ]; then
    echo "âŒ Found $SENSITIVE_FILES sensitive files!"
    find . -name "*.key" -o -name "*.pem" -o -name "*.p12" -o -name "*.pfx" -o -name "*.crt" -o -name "*.cer" -o -name "*.der" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./ios/.xcode.env" -not -path "./.env"
    echo "ğŸš« Push blocked due to sensitive files!"
    exit 1
fi
echo "âœ… No sensitive files found"

# 7. Final validation
echo "ğŸ” Final security validation..."
echo "âœ… All pre-push security checks passed! Push allowed."
