name: ðŸš€ Release Preparation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master]

permissions:
  pull-requests: write
  checks: write

jobs:
  release-preparation:
    runs-on: ubuntu-latest
    steps:
      - name: Add release checklist
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const { number } = context.payload.pull_request;

            // Add release labels
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: number,
              labels: ['release', 'cto-required']
            });

            // Create comprehensive release checklist
            const checklist = `ðŸš€ **RELEASE PREPARATION CHECKLIST**

**Pre-Release CTO Review:**
- [ ] Version number updated in package.json
- [ ] CHANGELOG.md updated with new features/fixes
- [ ] All tests passing
- [ ] Performance impact assessed
- [ ] Security review completed
- [ ] Breaking changes documented
- [ ] Migration guide provided (if needed)

**Release Readiness:**
- [ ] App store metadata updated
- [ ] Privacy policy updated (if needed)
- [ ] Security scan completed
- [ ] Performance benchmarks acceptable
- [ ] Rollback plan prepared

**Post-Release:**
- [ ] Monitor error rates
- [ ] Check performance metrics
- [ ] Verify user feedback
- [ ] Update documentation

**Mobile App Specific:**
- [ ] EAS build configuration updated
- [ ] Store listing screenshots current
- [ ] iOS/Android compatibility verified
- [ ] Deep linking tested

@IgorGanapolsky - This release requires your final CTO approval.`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: checklist
            });

            // Create release readiness check
            await github.rest.checks.create({
              owner,
              repo,
              name: 'Release Readiness',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: 'action_required',
              output: {
                title: 'CTO Release Approval Required',
                summary: 'This release requires CTO approval and checklist completion.'
              }
            });