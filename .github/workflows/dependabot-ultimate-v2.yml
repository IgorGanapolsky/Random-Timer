name: ğŸš€ Dependabot Fast-Track

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  checks: write
  actions: write

jobs:
  dependabot-fast-track:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: "20"
          cache: "npm"

      - name: Install and test
        id: test
        run: |
          echo "Installing dependencies..."
          npm ci --no-audit --no-fund --legacy-peer-deps || npm install --force

          echo "Running tests..."
          npm test || echo "test_failed=true" >> $GITHUB_OUTPUT

          echo "Running type check..."
          npx tsc --noEmit --skipLibCheck || echo "types_failed=true" >> $GITHUB_OUTPUT

      - name: Auto-approve and merge
        if: steps.test.outputs.test_failed != 'true' && steps.test.outputs.types_failed != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const { number } = context.payload.pull_request;

            // Auto-approve
            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number: number,
              event: 'APPROVE',
              body: 'ğŸ¤– Auto-approved by CTO automation - dependency update passed all checks'
            });

            // Enable auto-merge
            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: number,
              merge_method: 'squash',
              commit_title: `ğŸ¤– ${context.payload.pull_request.title}`,
              commit_message: 'Auto-merged by CTO dependency automation'
            });

      - name: Handle failures
        if: steps.test.outputs.test_failed == 'true' || steps.test.outputs.types_failed == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `ğŸš¨ **CTO Dependency Review Required**\n\nThis dependency update failed automated checks and requires manual CTO review.\n\n**Issues detected:**\n${steps.test.outputs.test_failed == 'true' ? '- âŒ Tests failed\n' : ''}${steps.test.outputs.types_failed == 'true' ? '- âŒ Type checking failed\n' : ''}\n\n@IgorGanapolsky Please review.`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: ['cto-review', 'dependency-issue']
            });