name: ðŸ”„ Real-Time Board Sync

on:
  issues:
    types: [opened, closed, reopened, labeled, unlabeled]
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  sync-boards:
    runs-on: ubuntu-latest
    steps:
      - name: Real-time Kanban/Issues Sync
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get all open issues
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              sort: 'updated',
              direction: 'desc',
              per_page: 50
            });

            console.log(`ðŸ”„ Syncing ${issues.data.length} issues with Kanban board`);

            let todoCount = 0;
            let inProgressCount = 0;
            let reviewCount = 0;

            for (const issue of issues.data) {
              const labels = issue.labels.map(l => l.name);
              const hasAiInProgress = labels.includes('ai:in-progress');
              const hasAiReady = labels.includes('ai:ready');
              const hasReview = labels.includes('review') || labels.includes('ready-for-review');

              // Count items per column
              if (hasAiInProgress) {
                inProgressCount++;
              } else if (hasReview) {
                reviewCount++;
              } else if (hasAiReady) {
                todoCount++;
              }

              // Add missing kanban-synced label
              if (!labels.includes('kanban-synced')) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issue.number,
                  labels: ['kanban-synced']
                });
              }
            }

            // Update project status issue with current board state
            const statusComment = `ðŸ“Š **Real-Time Board Status** (${new Date().toISOString()})

**Kanban Columns:**
- ðŸ“‹ To Do: ${todoCount} items
- ðŸ”„ In Progress: ${inProgressCount} items
- ðŸ‘€ Review: ${reviewCount} items

**Active AI Agents:** ${inProgressCount}
**Parallel Work Streams:** ${Math.min(inProgressCount, 3)}

**Recent Activity:**
${issues.data.slice(0, 3).map(i => `- #${i.number}: ${i.title} (${Math.floor((Date.now() - new Date(i.updated_at)) / (1000 * 60 * 60))}h ago)`).join('\n')}

---
*Auto-updated every 15 minutes by CTO board sync*`;

            // Post to project status issue
            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: 81, // Project status issue
                body: statusComment
              });
            } catch (error) {
              console.log(`Could not update status: ${error.message}`);
            }

  enable-parallel-agents:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Enable Multi-Agent Parallel Work
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get ai:ready issues for parallel assignment
            const readyIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'ai:ready',
              sort: 'created',
              direction: 'asc'
            });

            console.log(`ðŸš€ Enabling parallel work on ${readyIssues.data.length} ready issues`);

            // Start parallel work on up to 3 issues
            const maxParallelWork = 3;
            const issuesToStart = readyIssues.data.slice(0, maxParallelWork);

            for (const issue of issuesToStart) {
              // Move to in-progress
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issue.number,
                labels: ['ai:in-progress', 'multi-agent']
              });

              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: issue.number,
                name: 'ai:ready'
              });

              // Assign AI agents
              const agentComment = `ðŸ¤– **Parallel AI Agent Deployed**

**Multi-Agent Work Started:**
- Agent Type: Specialized for ${issue.labels.map(l => l.name).includes('testing') ? 'Testing' : 'Feature Development'}
- Priority: ${issue.labels.map(l => l.name).includes('ai:feature') ? 'High' : 'Normal'}
- Parallel Stream: ${issuesToStart.indexOf(issue) + 1} of ${issuesToStart.length}

**Real-time Updates:**
- Board sync every 15 minutes
- Progress tracking active
- CTO notifications enabled

**Expected Timeline:** 24-48 hours

---
*Multi-agent orchestration by CTO automation*`;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: agentComment
              });
            }

            // Summary comment on project status
            if (issuesToStart.length > 0) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: 81,
                body: `ðŸš€ **Parallel Agent Deployment**\n\n**${issuesToStart.length} AI agents** now working in parallel:\n${issuesToStart.map(i => `- #${i.number}: ${i.title}`).join('\n')}\n\n*CTO multi-agent orchestration active*`
              });
            }