name: ðŸ¤– Autonomous Issue Management

on:
  schedule:
    # Run every 6 hours to manage issues
    - cron: '0 */6 * * *'
  issues:
    types: [opened, labeled]
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write
  contents: write

jobs:
  manage-ai-ready-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process AI-ready issues
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get all open issues with ai:ready label
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'ai:ready',
              sort: 'updated',
              direction: 'asc'
            });

            console.log(`Found ${issues.data.length} AI-ready issues`);

            for (const issue of issues.data) {
              const hasInProgress = issue.labels.some(l => l.name === 'ai:in-progress');
              const daysSinceUpdate = Math.floor((Date.now() - new Date(issue.updated_at)) / (1000 * 60 * 60 * 24));

              console.log(`Issue #${issue.number}: ${issue.title} (${daysSinceUpdate} days old)`);

              // Start working on the oldest non-in-progress issue
              if (!hasInProgress && daysSinceUpdate >= 1) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issue.number,
                  labels: ['ai:in-progress']
                });

                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: issue.number,
                  name: 'ai:ready'
                });

                const progressComment = `ðŸ¤– **AI Agent Started Work**

I'm your autonomous development agent and I'm now working on this issue.

**Progress Tracking:**
- âœ… Issue assigned to AI agent
- ðŸ”„ Analysis and planning in progress
- â³ Implementation will follow

**Expected Timeline:**
- Analysis: 1-2 hours
- Implementation: 1-3 days
- Testing & Review: 1 day

I'll provide regular updates on progress. @${owner} will be notified when ready for review.

---
*This is an automated message from your CTO's AI development system.*`;

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: progressComment
                });

                // Only work on one issue at a time
                break;
              }
            }

  update-stale-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Update stale issues
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get all open issues
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              sort: 'updated',
              direction: 'asc'
            });

            for (const issue of issues.data) {
              const daysSinceUpdate = Math.floor((Date.now() - new Date(issue.updated_at)) / (1000 * 60 * 60 * 24));
              const hasStaleLabel = issue.labels.some(l => l.name === 'age: stale');
              const hasViolatedLabel = issue.labels.some(l => l.name === 'sla: violated');

              // Add stale label after 7 days
              if (daysSinceUpdate >= 7 && !hasStaleLabel) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issue.number,
                  labels: ['age: stale']
                });
              }

              // Add SLA violated after 14 days
              if (daysSinceUpdate >= 14 && !hasViolatedLabel) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issue.number,
                  labels: ['sla: violated']
                });

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: `âš ï¸ **SLA VIOLATION ALERT**\n\nThis issue has been open for ${daysSinceUpdate} days without updates.\n\n@${owner} - CTO attention required for priority assessment.`
                });
              }
            }

  create-work-items:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Auto-create implementation tasks
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;

            // Check for issues that need work items created
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'ai:in-progress'
            });

            for (const issue of issues.data) {
              const comments = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: issue.number
              });

              const hasTaskBreakdown = comments.data.some(c =>
                c.body.includes('Task Breakdown') || c.body.includes('Implementation Plan')
              );

              if (!hasTaskBreakdown) {
                const taskComment = `ðŸ”§ **Implementation Plan Generated**

**Task Breakdown:**
1. [ ] Research and analysis phase
2. [ ] Architecture planning
3. [ ] Core implementation
4. [ ] Testing and validation
5. [ ] Documentation updates
6. [ ] Code review preparation

**Technical Approach:**
- Follow existing code patterns and conventions
- Implement with TypeScript/React Native
- Ensure mobile-first responsive design
- Add comprehensive test coverage
- Update relevant documentation

**Estimated Completion:** 2-3 days

---
*Auto-generated by AI development agent*`;

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: taskComment
                });
              }
            }