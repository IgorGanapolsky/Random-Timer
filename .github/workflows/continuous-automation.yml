name: Continuous Automation System

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  
  push:
    branches: [main, develop]
  
  issues:
    types: [opened, closed, labeled, unlabeled]
  
  pull_request:
    types: [opened, synchronize, ready_for_review]
  
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  supervisor:
    name: Automated Supervisor
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Fix Stuck Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking for stuck issues..."
          
          # Find issues stuck in progress for >6 hours
          STUCK_ISSUES=$(gh issue list \
            --state open \
            --label "ai:in-progress" \
            --json number,updatedAt | \
            jq --arg date "$(date -u -d '6 hours ago' +%Y-%m-%dT%H:%M:%SZ)" \
            '[.[] | select(.updatedAt < $date) | .number]')
          
          if [ "$STUCK_ISSUES" != "[]" ] && [ ! -z "$STUCK_ISSUES" ]; then
            echo "$STUCK_ISSUES" | jq -r '.[]' | while read issue_num; do
              echo "‚ö†Ô∏è Unsticking issue #$issue_num"
              gh issue edit "$issue_num" \
                --remove-label "ai:in-progress" \
                --add-label "ai:ready" || true
              
              gh issue comment "$issue_num" \
                --body "üîÑ **Automated Recovery**: Issue was stuck. Resetting for retry."
            done
          fi
      
      - name: Trigger Agent Orchestrator
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          READY_COUNT=$(gh issue list --state open --label "ai:ready" --json number | jq '. | length')
          
          if [ "$READY_COUNT" -gt 0 ]; then
            echo "üöÄ Found $READY_COUNT issues ready for AI agents"
            gh workflow run agent-orchestrator.yml \
              --field max_agents=3 \
              --field dry_run=false || true
          else
            echo "No issues ready for processing"
          fi
      
      - name: Auto-Merge Ready PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîÄ Checking for mergeable PRs..."
          
          # Get all open PRs
          gh pr list --state open --json number,mergeable,labels,statusCheckRollup | \
          jq -c '.[]' | while read pr; do
            PR_NUM=$(echo "$pr" | jq -r '.number')
            MERGEABLE=$(echo "$pr" | jq -r '.mergeable')
            HAS_AUTO_MERGE=$(echo "$pr" | jq '.labels[] | select(.name == "auto-merge")' | wc -l)
            
            if [ "$HAS_AUTO_MERGE" -gt 0 ] && [ "$MERGEABLE" == "MERGEABLE" ]; then
              echo "‚úÖ Merging PR #$PR_NUM"
              gh pr merge "$PR_NUM" --squash --delete-branch || \
                echo "Could not merge PR #$PR_NUM"
            fi
          done
      
      - name: Create Issues from Backlog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OPEN_ISSUES=$(gh issue list --state open --json number | jq '. | length')
          
          if [ "$OPEN_ISSUES" -lt 5 ]; then
            echo "üìù Creating new issues from backlog..."
            
            # List of potential features to implement
            FEATURES=(
              "üîê:Implement password sharing:Share passwords securely with team members:security,backend"
              "üì±:Add mobile biometric unlock:Use FaceID/TouchID for app access:mobile,security"
              "üîÑ:Implement password rotation reminders:Notify users to change old passwords:backend,automation"
              "üìä:Add security dashboard:Visual overview of password health:frontend,analytics"
              "üåê:Multi-language support:Internationalization for global users:frontend,i18n"
              "üíæ:Offline mode support:Access passwords without internet:mobile,offline"
              "üîç:Advanced search filters:Search by category, date, strength:frontend,search"
              "üìà:Usage analytics:Track password usage patterns:analytics,backend"
              "üé®:Custom themes:User-customizable color schemes:frontend,ux"
              "‚ö°:Performance optimization:Speed up app loading and operations:performance,optimization"
            )
            
            # Pick a random feature
            RANDOM_INDEX=$((RANDOM % ${#FEATURES[@]}))
            FEATURE="${FEATURES[$RANDOM_INDEX]}"
            
            IFS=':' read -r emoji title body labels <<< "$FEATURE"
            
            # Check if issue already exists
            if ! gh issue list --state all --search "in:title $title" --json number | jq -e '.[0]' > /dev/null 2>&1; then
              gh issue create \
                --title "$emoji $title" \
                --body "$body" \
                --label "$labels,ai:ready" || true
            fi
          fi
      
      - name: Update Metrics
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìä Current System Status:"
          echo "========================"
          
          OPEN_ISSUES=$(gh issue list --state open --json number | jq '. | length')
          OPEN_PRS=$(gh pr list --state open --json number | jq '. | length')
          AI_READY=$(gh issue list --state open --label "ai:ready" --json number | jq '. | length')
          AI_WORKING=$(gh issue list --state open --label "ai:in-progress" --json number | jq '. | length')
          
          echo "üìã Open Issues: $OPEN_ISSUES"
          echo "üîÄ Open PRs: $OPEN_PRS"
          echo "üéØ Ready for AI: $AI_READY"
          echo "ü§ñ AI Working: $AI_WORKING"
          
          # Calculate velocity
          CLOSED_THIS_WEEK=$(gh issue list --state closed --limit 100 --json closedAt | \
            jq --arg date "$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)" \
            '[.[] | select(.closedAt > $date)] | length')
          
          echo "‚ö° Issues closed this week: $CLOSED_THIS_WEEK"
          
          # Create summary for step
          {
            echo "## üìä Automation Status"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Open Issues | $OPEN_ISSUES |"
            echo "| Open PRs | $OPEN_PRS |"
            echo "| Ready for AI | $AI_READY |"
            echo "| AI Working | $AI_WORKING |"
            echo "| Weekly Velocity | $CLOSED_THIS_WEEK |"
          } >> $GITHUB_STEP_SUMMARY

  parallel-agents:
    name: Parallel Agent Execution
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        worktree: [security, frontend, backend, mobile, ai]
      max-parallel: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Process Issues in Worktree
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ü§ñ Agent ${{ matrix.worktree }} checking for work..."
          
          # Map worktree to issue labels
          case "${{ matrix.worktree }}" in
            security)
              LABEL_FILTER="security,encryption,auth"
              ;;
            frontend)
              LABEL_FILTER="frontend,ui,ux"
              ;;
            backend)
              LABEL_FILTER="backend,api,database"
              ;;
            mobile)
              LABEL_FILTER="mobile,ios,android"
              ;;
            ai)
              LABEL_FILTER="ai,ml,automation"
              ;;
          esac
          
          # Find matching ready issues
          for label in $(echo $LABEL_FILTER | tr ',' ' '); do
            ISSUE=$(gh issue list \
              --state open \
              --label "ai:ready" \
              --label "$label" \
              --json number,title \
              --limit 1 \
              --jq '.[0]')
            
            if [ ! -z "$ISSUE" ] && [ "$ISSUE" != "null" ]; then
              ISSUE_NUM=$(echo "$ISSUE" | jq -r '.number')
              ISSUE_TITLE=$(echo "$ISSUE" | jq -r '.title')
              
              echo "üìã Found issue #$ISSUE_NUM: $ISSUE_TITLE"
              
              # Claim the issue
              gh issue edit "$ISSUE_NUM" \
                --add-label "ai:in-progress" \
                --remove-label "ai:ready" || true
              
              gh issue comment "$ISSUE_NUM" \
                --body "ü§ñ **${{ matrix.worktree }} Agent**: Starting work on this issue"
              
              # Trigger dedicated executor
              gh workflow run agent-executor.yml \
                --field issue_number="$ISSUE_NUM" \
                --field agent_type="${{ matrix.worktree }}" \
                --field dry_run=false || true
              
              break
            fi
          done

  monitoring:
    name: System Health Monitor
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Check System Health
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üè• Running health checks..."
          
          # Check API rate limit
          RATE_LIMIT=$(gh api rate_limit --jq '.resources.core.remaining')
          RATE_RESET=$(gh api rate_limit --jq '.resources.core.reset')
          
          echo "API Rate Limit: $RATE_LIMIT remaining"
          
          if [ "$RATE_LIMIT" -lt 100 ]; then
            echo "‚ö†Ô∏è Low API rate limit! Waiting until reset at $(date -d @$RATE_RESET)"
            exit 1
          fi
          
          # Check workflow runs
          FAILED_RUNS=$(gh run list --workflow=agent-orchestrator.yml --status=failure --limit=5 --json conclusion | jq '. | length')
          
          if [ "$FAILED_RUNS" -gt 3 ]; then
            echo "‚ö†Ô∏è Multiple orchestrator failures detected"
            
            # Create issue for investigation
            gh issue create \
              --title "üö® Agent Orchestrator Failures" \
              --body "Multiple orchestrator failures detected. Manual investigation needed." \
              --label "bug,automation,priority:high" || true
          fi
