name: ðŸŽ¯ REAL Kanban Automation

on:
  issues:
    types: [opened, labeled, unlabeled, assigned, unassigned]
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  move-items-to-columns:
    runs-on: ubuntu-latest
    steps:
      - name: Move Issues to Correct Columns
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          PROJECT_ID: "PVT_kwHOAAMR-c4BCPGq"
          STATUS_FIELD_ID: "PVTSSF_lAHOAAMR-c4BCPGqzg0gbWE"
        run: |
          # Get all project items
          PROJECT_ITEMS=$(gh api graphql -f query='
          query($projectId: ID!) {
            node(id: $projectId) {
              ... on ProjectV2 {
                items(first: 50) {
                  nodes {
                    id
                    content {
                      ... on Issue {
                        id
                        number
                        labels(first: 20) {
                          nodes {
                            name
                          }
                        }
                        state
                      }
                    }
                    fieldValueByName(name: "Status") {
                      ... on ProjectV2ItemFieldSingleSelectValue {
                        name
                      }
                    }
                  }
                }
              }
            }
          }' -f projectId="$PROJECT_ID" --jq '.data.node.items.nodes')

          echo "Found project items: $PROJECT_ITEMS"

          # Process each item
          echo "$PROJECT_ITEMS" | jq -c '.[]' | while read -r item; do
            ITEM_ID=$(echo "$item" | jq -r '.id')
            ISSUE_NUMBER=$(echo "$item" | jq -r '.content.number // empty')
            CURRENT_STATUS=$(echo "$item" | jq -r '.fieldValueByName.name // "No Status"')
            ISSUE_STATE=$(echo "$item" | jq -r '.content.state // empty')

            if [ "$ISSUE_NUMBER" = "" ] || [ "$ISSUE_NUMBER" = "null" ]; then
              echo "Skipping non-issue item: $ITEM_ID"
              continue
            fi

            # Get issue labels
            LABELS=$(echo "$item" | jq -r '.content.labels.nodes[].name' | tr '\n' ' ')
            echo "Issue #$ISSUE_NUMBER - Current: $CURRENT_STATUS - Labels: $LABELS - State: $ISSUE_STATE"

            # Determine target column
            TARGET_COLUMN=""
            TARGET_OPTION_ID=""

            if echo "$LABELS" | grep -q "ai:in-progress"; then
              TARGET_COLUMN="In Progress"
              TARGET_OPTION_ID="47fc9ee4"
            elif echo "$LABELS" | grep -q "ai:ready"; then
              TARGET_COLUMN="To Do"
              TARGET_OPTION_ID="f75ad846"
            elif echo "$LABELS" | grep -q "review\|ready-for-review"; then
              TARGET_COLUMN="Review"
              TARGET_OPTION_ID="c8b5dbeb"
            elif [ "$ISSUE_STATE" = "CLOSED" ]; then
              TARGET_COLUMN="Done"
              TARGET_OPTION_ID="98236657"
            fi

            # Move item if needed
            if [ "$TARGET_COLUMN" != "" ] && [ "$CURRENT_STATUS" != "$TARGET_COLUMN" ]; then
              echo "Moving issue #$ISSUE_NUMBER from '$CURRENT_STATUS' to '$TARGET_COLUMN'"

              RESULT=$(gh api graphql -f query='
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: {
                      singleSelectOptionId: $optionId
                    }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }' \
              -f projectId="$PROJECT_ID" \
              -f itemId="$ITEM_ID" \
              -f fieldId="$STATUS_FIELD_ID" \
              -f optionId="$TARGET_OPTION_ID")

              if echo "$RESULT" | jq -e '.data.updateProjectV2ItemFieldValue.projectV2Item.id' > /dev/null; then
                echo "âœ… Successfully moved issue #$ISSUE_NUMBER to $TARGET_COLUMN"
              else
                echo "âŒ Failed to move issue #$ISSUE_NUMBER: $RESULT"
              fi
            else
              echo "Issue #$ISSUE_NUMBER already in correct column or no target determined"
            fi
          done

  enable-multi-agent-work:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Start Multi-Agent Parallel Work
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get ready issues for parallel work
            const readyIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'ai:ready',
              sort: 'created',
              direction: 'asc'
            });

            console.log(`ðŸš€ Found ${readyIssues.data.length} issues ready for parallel work`);

            // Start work on up to 3 issues simultaneously
            const maxParallel = 3;
            const currentInProgress = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'ai:in-progress'
            });

            const availableSlots = maxParallel - currentInProgress.data.length;
            const issuesToStart = readyIssues.data.slice(0, availableSlots);

            console.log(`${currentInProgress.data.length} agents working, ${availableSlots} slots available`);

            for (const issue of issuesToStart) {
              // Move to in-progress
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: issue.number,
                name: 'ai:ready'
              });

              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issue.number,
                labels: ['ai:in-progress', 'multi-agent']
              });

              console.log(`âœ… Started AI agent on issue #${issue.number}: ${issue.title}`);

              // Agent assignment comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: `ðŸ¤– **Multi-Agent AI Started**\n\n**Parallel Work Stream:** ${issuesToStart.indexOf(issue) + 1} of ${issuesToStart.length}\n**Kanban Status:** Moving to In Progress\n**Auto-sync:** Every 10 minutes\n\nWork beginning now...`
              });
            }

            if (issuesToStart.length > 0) {
              // Update project status
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: 81,
                body: `ðŸš€ **Multi-Agent Deployment**\n\n**${issuesToStart.length} new AI agents** deployed:\n${issuesToStart.map(i => `- #${i.number}: ${i.title}`).join('\n')}\n\n**Total Active:** ${currentInProgress.data.length + issuesToStart.length} agents\n**Kanban Sync:** Every 10 minutes\n\n*Real automation now active*`
              });
            }