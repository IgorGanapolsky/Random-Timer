name: üéØ Kanban Board Automation

on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled, assigned, unassigned]
  pull_request:
    types: [opened, edited, closed, reopened, ready_for_review, converted_to_draft]
  schedule:
    # Sync every 30 minutes during work hours
    - cron: '*/30 8-18 * * 1-5'
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write
  repository-projects: write

env:
  PROJECT_ID: 3
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-kanban-board:
    runs-on: ubuntu-latest
    steps:
      - name: Sync Issues to Kanban Board
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const projectId = parseInt(process.env.PROJECT_ID);

            console.log(`Syncing repository ${owner}/${repo} with project ${projectId}`);

            // Get all open issues
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              per_page: 100
            });

            console.log(`Found ${issues.data.length} open issues`);

            // Get current project items
            const query = `
              query($owner: String!, $projectNumber: Int!) {
                user(login: $owner) {
                  projectV2(number: $projectNumber) {
                    id
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            number
                            url
                          }
                          ... on PullRequest {
                            number
                            url
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const projectData = await github.graphql(query, {
              owner,
              projectNumber: projectId
            });

            const projectItems = projectData.user.projectV2.items.nodes;
            const existingIssueNumbers = projectItems
              .filter(item => item.content && item.content.number)
              .map(item => item.content.number);

            console.log(`Project has ${projectItems.length} items, ${existingIssueNumbers.length} are issues/PRs`);

            // Add missing issues to project
            for (const issue of issues.data) {
              if (!existingIssueNumbers.includes(issue.number)) {
                try {
                  await github.rest.projects.createCard({
                    column_id: 'TODO_COLUMN_ID', // Will be set via GraphQL
                    content_id: issue.id,
                    content_type: 'Issue'
                  });
                  console.log(`Added issue #${issue.number} to project`);
                } catch (error) {
                  console.log(`Could not add issue #${issue.number}: ${error.message}`);
                }
              }
            }

  update-kanban-status:
    runs-on: ubuntu-latest
    steps:
      - name: Update Kanban Status Based on Labels
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;

            // Issue or PR that triggered this workflow
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            if (!issueNumber) return;

            const item = context.payload.issue || context.payload.pull_request;
            const labels = item.labels || [];
            const labelNames = labels.map(l => l.name);

            console.log(`Processing item #${issueNumber} with labels: ${labelNames.join(', ')}`);

            // Determine column based on labels and state
            let targetColumn = 'To Do';

            if (labelNames.includes('ai:in-progress') || labelNames.includes('in-progress')) {
              targetColumn = 'In Progress';
            } else if (item.state === 'closed' && (item.merged || item.closed_at)) {
              targetColumn = 'Done';
            } else if (labelNames.includes('review') || labelNames.includes('ready-for-review')) {
              targetColumn = 'Review';
            } else if (labelNames.includes('ai:ready') || labelNames.includes('ready')) {
              targetColumn = 'To Do';
            }

            console.log(`Target column for #${issueNumber}: ${targetColumn}`);

            // Update project item status
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: $value
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            // Note: This would need proper project field IDs
            console.log(`Would update item to column: ${targetColumn}`);

  assign-ai-agents:
    runs-on: ubuntu-latest
    if: github.event.action == 'labeled' && contains(github.event.label.name, 'ai:')
    steps:
      - name: Assign AI Agents for Parallel Work
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue.number;
            const labelName = context.payload.label.name;

            console.log(`AI label "${labelName}" added to issue #${issueNumber}`);

            // Assign different AI agents based on work type
            const agentAssignments = {
              'ai:testing': ['github-actions[bot]', 'dependabot[bot]'],
              'ai:documentation': ['github-actions[bot]'],
              'ai:feature': ['github-actions[bot]', 'codecov[bot]'],
              'ai:security': ['github-actions[bot]', 'gitguardian[bot]'],
              'ai:in-progress': ['github-actions[bot]']
            };

            const assignees = agentAssignments[labelName] || ['github-actions[bot]'];

            // Add progress tracking comment
            const progressComment = `ü§ñ **Multi-Agent Assignment**

**AI Agents Assigned:**
${assignees.map(agent => `- ${agent}`).join('\n')}

**Parallel Work Initiated:**
- Real-time progress tracking enabled
- Kanban board sync activated
- Status updates every 30 minutes

**Estimated Completion:** Based on agent capacity and work complexity

---
*Automated by CTO's multi-agent orchestration system*`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: progressComment
            });

            // Add project management labels
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: ['kanban-synced', 'multi-agent']
            });

  parallel-work-monitor:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Monitor Parallel Work Progress
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get all issues with ai:in-progress
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'ai:in-progress'
            });

            console.log(`Monitoring ${issues.data.length} active AI work items`);

            for (const issue of issues.data) {
              const daysSinceUpdate = Math.floor((Date.now() - new Date(issue.updated_at)) / (1000 * 60 * 60 * 24));

              if (daysSinceUpdate >= 1) {
                // Post progress update
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: `‚è∞ **Daily Progress Check**\n\nAI Agent working on this issue. Last update: ${daysSinceUpdate} day(s) ago.\n\n*Automated monitoring by CTO system*`
                });
              }
            }